<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HOSQ Labs</title>
  <script src='https://d3js.org/d3.v7.min.js'></script>
  <style>
    /* Lexend Font Face Declarations */
    @font-face {
      font-family: 'Lexend';
      src: url('./Lexend-Regular.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
    }
    @font-face {
      font-family: 'Lexend';
      src: url('./Lexend-Medium.ttf') format('truetype');
      font-weight: 500;
      font-style: normal;
    }
    :root {
      --page-bg: #262123;
      --page-text: #E8DED3;
      --accent: #6A50FF;
      --edge: #322C2E;
      --label-muted: #4C4646;
      --popup-bg: #262123;
      --popup-text: #E8DED3;
      --tag-bg: #E8DED3;
      --tag-text: #262123;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      background: var(--page-bg);
      color: var(--page-text);
      font-family: 'Lexend', sans-serif;
      overflow: hidden;
    }

    .layout {
      display: grid;
      grid-template-columns: 1fr;
      grid-template-rows: 100vh;
      width: 100vw;
      height: 100vh;
    }

    .content { 
      position: relative; 
      width: 100%;
      height: 100%;
      overflow: hidden;
    }
    
    svg { 
      width: 100%; 
      height: 100%; 
      cursor: grab; 
      display: block; 
    }

    /* Top Buttons (Filters and Fullscreen) */
    .top-btn {
      position: absolute;
      top: 16px;
      z-index: 200;
      padding: 8px 16px;
      background-color: rgba(255, 255, 255, 0.1);
      color: #E8DED3;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      font-family: 'Lexend', sans-serif;
      cursor: pointer;
      transition: all 0.2s;
    }

    .top-btn:hover {
      background-color: rgba(255, 255, 255, 0.15);
    }

    #filters-btn {
      left: 16px;
    }

    #fullscreen-btn {
      right: 16px;
    }

    /* Header Logo */
    .header-logo {
      position: absolute;
      top: 16px;
      left: 50%;
      transform: translateX(-50%);
      height: 60px;
      width: auto;
      object-fit: contain;
      z-index: 200;
    }

    /* Filters Popup Backdrop */
    .filters-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 299;
      display: none;
    }

    .filters-backdrop.active {
      display: block;
    }

    /* Filters Popup */
    .filters-popup {
      position: fixed;
      top: 80px;
      left: 16px;
      background-color: var(--page-bg);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      z-index: 300;
      display: none;
      width: 320px;
      max-height: calc(100vh - 100px);
      overflow: hidden;
      font-family: 'Lexend', sans-serif;
    }

    .filters-popup.active {
      display: block;
    }

    @media (max-width: 768px) {
      .filters-popup {
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 90vw;
        max-width: 400px;
        max-height: 80vh;
      }
    }

    .filters-popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .filters-popup-header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .close-filters-btn {
      background: none;
      border: none;
      color: var(--page-text);
      font-size: 28px;
      cursor: pointer;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background-color 0.2s;
      padding: 0;
      line-height: 1;
    }

    .close-filters-btn:hover {
      background-color: rgba(255, 255, 255, 0.1);
    }

    .filters-popup-content {
      padding: 20px;
      overflow-y: auto;
      max-height: calc(80vh - 70px);
    }

    .filter-group {
      margin-bottom: 24px;
    }

    .filter-group h3 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: rgba(232, 222, 211, 0.7);
    }

    .filter-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .filter-tag {
      background-color: rgba(255, 255, 255, 0.1);
      color: var(--page-text);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      transition: all 0.2s;
    }

    .filter-tag:hover {
      background-color: rgba(255, 255, 255, 0.15);
    }

    .filter-tag.active {
      background-color: var(--tag-bg);
      color: var(--tag-text);
      border-color: var(--tag-bg);
    }

    #search-input {
      width: 100%;
      padding: 8px 12px;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: var(--page-text);
      font-size: 14px;
      font-family: inherit;
    }

    #search-input:focus {
      outline: none;
      border-color: var(--tag-bg);
      background-color: rgba(255, 255, 255, 0.15);
    }

    #search-input::placeholder {
      color: rgba(232, 222, 211, 0.5);
    }

    .reset-btn {
      width: 100%;
      padding: 10px;
      background-color: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      color: var(--page-text);
      font-size: 14px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reset-btn:hover {
      background-color: rgba(255, 255, 255, 0.15);
    }

    .popup {
      position: absolute;
      background-color: var(--popup-bg);
      color: var(--popup-text);
      padding: 8px;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      z-index: 10;
      width: 220px;
      text-align: center;
      font-size: 14px;
      user-select: text;
      pointer-events: auto;
      display: none;
    }

    .popup img { max-width: 100%; border-radius: 6px; margin-top: 8px; margin-bottom: 4px; }
  </style>
</head>
<body>
  <div class="layout">
    <main class="content">
      <button id="filters-btn" class="top-btn">filters</button>
      <img src="hosq_logo.png" alt="HOSQ Logo" class="header-logo">
      <button id="fullscreen-btn" class="top-btn">full screen</button>
      <svg></svg>
      <div id='popup' class='popup' style='user-select: text; -webkit-user-select: text;'></div>
    </main>
  </div>

  <!-- Filters Popup Backdrop -->
  <div id="filters-backdrop" class="filters-backdrop"></div>
  
  <!-- Filters Popup -->
  <div id="filters-popup" class="filters-popup">
    <div class="filters-popup-header">
      <h2>Filters</h2>
      <button id="close-filters" class="close-filters-btn">&times;</button>
    </div>
    
    <div class="filters-popup-content">
      <div id="filters"></div>
      
      <!-- Search Filter -->
      <div class="filter-group">
        <h3>Search</h3>
        <input type="text" id="search-input" placeholder="Search artist...">
      </div>

      <!-- Reset Button -->
      <button id="reset-filters" class="reset-btn">Reset filters</button>
    </div>
  </div>

  <script>
    // ============================================
    // Fullscreen Functionality
    // ============================================
    function openFullscreen() {
      const docElm = document.documentElement;
      if (docElm.requestFullscreen) { docElm.requestFullscreen(); }
      else if (docElm.webkitRequestFullscreen) { docElm.webkitRequestFullscreen(); }
      else if (docElm.msRequestFullscreen) { docElm.msRequestFullscreen(); }
    }
    document.getElementById('fullscreen-btn').addEventListener('click', openFullscreen);

    // ============================================
    // Filters Popup Toggle
    // ============================================
    const filtersBtn = document.getElementById('filters-btn');
    const filtersPopup = document.getElementById('filters-popup');
    const filtersBackdrop = document.getElementById('filters-backdrop');
    const closeFiltersBtn = document.getElementById('close-filters');
    const resetFiltersBtn = document.getElementById('reset-filters');

    function openFilters() {
      filtersPopup.classList.add('active');
      filtersBackdrop.classList.add('active');
    }

    function closeFilters() {
      filtersPopup.classList.remove('active');
      filtersBackdrop.classList.remove('active');
    }

    filtersBtn.addEventListener('click', openFilters);
    closeFiltersBtn.addEventListener('click', closeFilters);
    filtersBackdrop.addEventListener('click', closeFilters);

    // ============================================
    // Utility Functions
    // ============================================
    // Escape @ symbol in text to prevent email/telegram link issues
    function escapeAt(text) {
      return typeof text === 'string' ? text.replaceAll('@', '&#64;') : text;
    }

    // Track all filter tags for reset functionality
    let allFilterTags = [];

    // ============================================
    // Filter UI Builder
    // ============================================
    // Builds the filter interface from filter options
    function buildFilters(container, filterOptions, onChange) {
      const order = ['lab','department','role','discipline','instruments','skill set'];
      const selected = {};
      order.forEach(cat => { selected[cat] = new Set(); });

      const root = document.createDocumentFragment();
      order.forEach(cat => {
        const values = Array.from(filterOptions[cat] || []).sort();
        if (!values.length) return;
        const group = document.createElement('div');
        group.className = 'filter-group';
        const h3 = document.createElement('h3');
        h3.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
        group.appendChild(h3);
        const opts = document.createElement('div');
        opts.className = 'filter-options';
        values.forEach(val => {
          const tag = document.createElement('button');
          tag.type = 'button';
          tag.className = 'filter-tag';
          tag.textContent = val;
          tag.setAttribute('aria-pressed', 'false');
          tag.addEventListener('click', () => {
            const pressed = tag.getAttribute('aria-pressed') === 'true';
            tag.setAttribute('aria-pressed', String(!pressed));
            tag.classList.toggle('active', !pressed);
            if (pressed) selected[cat].delete(val); else selected[cat].add(val);
            onChange(mapToSelected(selected));
          });
          opts.appendChild(tag);
          allFilterTags.push(tag);
        });
        group.appendChild(opts);
        root.appendChild(group);
      });
      container.innerHTML = '';
      container.appendChild(root);
      return mapToSelected(selected);
    }

    function mapToSelected(map) {
      const out = {};
      Object.keys(map).forEach(k => { out[k] = Array.from(map[k]); });
      return out;
    }

    // Reset all active filters and clear search
    function resetFilters() {
      allFilterTags.forEach(tag => {
        tag.setAttribute('aria-pressed', 'false');
        tag.classList.remove('active');
      });
      const empty = {};
      ['lab','department','role','discipline','instruments','skill set'].forEach(cat => { empty[cat] = []; });
      if (window.currentOnChange) window.currentOnChange(empty);
      document.getElementById('search-input').value = '';
    }

    // Reset all filters when reset button is clicked
    resetFiltersBtn.addEventListener('click', resetFilters);

    function computeArtistLinksMap(links) {
      const map = new Map();
      links.forEach(l => {
        const s = typeof l.source === 'string' ? l.source : l.source.id;
        const t = typeof l.target === 'string' ? l.target : l.target.id;
        if (s.startsWith('artist::')) {
          if (!map.has(s)) map.set(s, new Set());
          map.get(s).add(t);
        }
        if (t.startsWith('artist::')) {
          if (!map.has(t)) map.set(t, new Set());
          map.get(t).add(s);
        }
      });
      return map;
    }

    // Check if an artist passes all active filter criteria
    function artistPassesFilter(artistId, selected, artistLinksMap) {
      for (const [cat, vals] of Object.entries(selected)) {
        if (!vals || vals.length === 0) continue;
        const relevant = new Set(vals.map(v => `${cat}::${v}`));
        const connected = artistLinksMap.get(artistId) || new Set();
        let hasAny = false;
        for (const r of relevant) {
          if (connected.has(r)) { hasAny = true; break; }
        }
        if (!hasAny) return false;
      }
      return true;
    }

    // ============================================
    // Graph Rendering
    // ============================================
    // Main function to render the D3 force-directed graph
    function renderGraph(data, selected) {
      const svg = d3.select('svg');
      svg.selectAll('*').remove();
      const width = svg.node().clientWidth;
      const height = svg.node().clientHeight;

      // Create main group for zoom/pan transformations
      const g = svg.append('g');

      // Setup zoom and pan functionality
      const zoom = d3.zoom().scaleExtent([0.3, 4]).on('zoom', (event) => {
        g.attr('transform', event.transform);
      });
      svg.call(zoom);
      
      // Set initial zoom scale to 2x (double the size)
      // Translate to keep the center point in the same visual position when scaling
      const initialScale = 1.5;
      const centerX = width / 2;
      const centerY = height / 2;
      const initialTransform = d3.zoomIdentity
        .translate(centerX * (1 - initialScale), centerY * (1 - initialScale))
        .scale(initialScale);
      svg.call(zoom.transform, initialTransform);

      // Compute which category nodes each artist is connected to
      const artistLinksMap = computeArtistLinksMap(data.links);

      // Filter artists based on selected criteria
      const visibleArtistIds = new Set(Object.keys(data.artists).filter(a => artistPassesFilter(a, selected, artistLinksMap)));
      // Include all category nodes connected to visible artists
      const visibleRelatedIds = new Set(visibleArtistIds);

      data.links.forEach(l => {
        const s = typeof l.source === 'string' ? l.source : l.source.id;
        const t = typeof l.target === 'string' ? l.target : l.target.id;
        if (visibleArtistIds.has(s)) visibleRelatedIds.add(t);
        if (visibleArtistIds.has(t)) visibleRelatedIds.add(s);
      });

      const nodes = data.nodes.filter(n => visibleRelatedIds.has(n.id));
      const links = data.links.filter(l => visibleRelatedIds.has(typeof l.source === 'string' ? l.source : l.source.id) && visibleRelatedIds.has(typeof l.target === 'string' ? l.target : l.target.id));

      // Node radius constant
      const NODE_RADIUS = 10;
      // Minimum distance between nodes = radius * 5 (ensures nodes don't overlap)
      const MIN_NODE_DISTANCE = NODE_RADIUS * 5;

      // D3 force simulation setup
      // Center the graph in the middle of the viewport
      const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(MIN_NODE_DISTANCE))
        .force('charge', d3.forceManyBody().strength(-60))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('x', d3.forceX(width / 2).strength(0.2))
        .force('y', d3.forceY(height / 2).strength(0.2));

      // Create link lines between nodes
      const link = g.append('g')
        .selectAll('line')
        .data(links)
        .enter().append('line')
        .attr('stroke', '#322C2E');

      // Track which node is currently showing popup
      let popupNode = null;

      // Create node circles with radius
      const node = g.append('g')
        .selectAll('circle')
        .data(nodes)
        .enter().append('circle')
        .attr('r', NODE_RADIUS)
        .attr('fill', d => d.color)
        .attr('class', 'node')
        .call(d3.drag()
          .on('start', function(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; })
          .on('drag', function(event, d) { d.fx = event.x; d.fy = event.y; })
          .on('end', function(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; })
        )
        .on('mouseover', function(event, d) {
          onHover(event, d, data, node, link, labels, svg);
          popupNode = d;
          const connected = new Set();
          links.forEach(l => { if (l.source.id === d.id) connected.add(l.target.id); if (l.target.id === d.id) connected.add(l.source.id); });
          node.attr('opacity', n => connected.has(n.id) || n.id === d.id ? 1 : 0.5);
          link.attr('stroke', l => (l.source.id === d.id || l.target.id === d.id) ? '#6A50FF' : '#322C2E')
              .attr('opacity', l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.2);
        })
        .on('mouseout', function(event, d) {
          if (!popupNode || popupNode.id !== d.id) { document.getElementById('popup').style.display = 'none'; }
          node.attr('opacity', 1);
          link.attr('stroke', '#322C2E').attr('opacity', 1);
        })
        .on('click', function(event, d) {
          event.stopPropagation();
          popupNode = d;
          const firstDegree = new Set();
          const secondDegree = new Set();
          links.forEach(l => { if (l.source.id === d.id) firstDegree.add(l.target.id); if (l.target.id === d.id) firstDegree.add(l.source.id); });
          let allVisible;
          if (d.id.startsWith('artist::')) {
            links.forEach(l => { if (firstDegree.has(l.source.id)) secondDegree.add(l.target.id); if (firstDegree.has(l.target.id)) secondDegree.add(l.source.id); });
            allVisible = new Set([d.id, ...firstDegree, ...secondDegree]);
          } else {
            allVisible = new Set([d.id, ...firstDegree]);
          }
          node.attr('display', n => allVisible.has(n.id) ? null : 'none');
          link.attr('display', l => allVisible.has(l.source.id) && allVisible.has(l.target.id) ? null : 'none');
          labels.attr('display', n => allVisible.has(n.id) ? null : 'none')
                .attr('opacity', n => firstDegree.has(n.id) || n.id === d.id ? 1 : 0.5);
        });

      // Create text labels for nodes
      const labels = g.append('g')
        .selectAll('text')
        .data(nodes)
        .enter().append('text')
        .text(d => d.label)
        .attr('font-size', 6)
        .attr('text-anchor', 'middle')
        .attr('dy', 8)
        .attr('fill', '#E8DED3')
        .attr('pointer-events', 'none')
        .style('font-family', 'Lexend, sans-serif');

      // Update positions on each simulation tick
      simulation.on('tick', () => {
        link.attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
        node.attr('cx', d => d.x).attr('cy', d => d.y);
        labels.attr('x', d => d.x).attr('y', d => d.y + 8);
        // Update popup position if one is showing
        if (popupNode) updatePopupPosition(popupNode, svg);
      });

      svg.on('click', () => {
        popupNode = null;
        document.getElementById('popup').style.display = 'none';
        node.attr('display', null).attr('opacity', 1).attr('stroke', null).attr('stroke-width', null);
        link.attr('display', null).attr('stroke', '#322C2E').attr('opacity', 1);
        labels.attr('display', null).attr('opacity', 1);
        const si = document.getElementById('search-input'); if (si) si.value = '';
      });

      document.getElementById('search-input').addEventListener('input', (e) => {
        const query = e.target.value.toLowerCase();
        node.attr('stroke', d => d.id.startsWith('artist::') && d.label.toLowerCase().includes(query) ? '#6A50FF' : null)
            .attr('stroke-width', d => d.id.startsWith('artist::') && d.label.toLowerCase().includes(query) ? 3 : null);
      });
    }

    // ============================================
    // Popup and Interaction Handlers
    // ============================================
    // Handle hover events to show popup with node information
    function onHover(event, d, data, node, link, labels, svg) {
      const popup = document.getElementById('popup');
      let html = '';
      if (d.id.startsWith('artist::')) {
        const artist = data.artists[d.id];
        html = `
          <strong>${artist.name}</strong><br>
          ${artist.role ? `<div><span style='color: #4C4646;'>${artist.role}</span></div>` : ''}
          <img src="${artist.photo}" alt="photo"><br>
          ${(artist.country || artist.city) ? `<div><span style='color: #6A50FF;'>${artist.country}${artist.city ? ', ' + artist.city : ''}</span></div>` : ''}
          ${artist.lab ? `<div><span style='color: var(--popup-text);'>lab:</span> <span style='color: #6A50FF;'>${artist.lab}</span></div>` : ''}
          ${artist.department ? `<div><span style='color: var(--popup-text);'>department:</span> <span style='color: #4C4646;'>${artist.department}</span></div>` : ''}
          ${artist.discipline ? `<div><span style='color: var(--popup-text);'>disciplines:</span> <span style='color: #4C4646;'>${artist.discipline}</span></div>` : ''}
          ${artist.instruments ? `<div><span style='color: var(--popup-text);'>instruments:</span> <span style='color: #4C4646;'>${artist.instruments}</span></div>` : ''}
        `;
      } else {
        if (d.id.startsWith('seeking for::')) {
          html = `
            <div>
              <span style="color: #4C4646;">seeking for:</span>
              <span style="color: var(--popup-text);">${d.label}</span>
            </div>`;
        } else {
          html = `<div><strong>${d.label}</strong></div>`;
        }
      }
      popup.innerHTML = html;
      popup.style.display = 'block';
      updatePopupPosition(d, svg);

      if (!d.id.startsWith('artist::')) {
        const connected = new Set();
        d3.selectAll('line').data().forEach(l => { if (l.source.id === d.id) connected.add(l.target.id); if (l.target.id === d.id) connected.add(l.source.id); });
        node.attr('opacity', n => connected.has(n.id) || n.id === d.id ? 1 : 0.1);
        link.attr('stroke', l => (l.source.id === d.id || l.target.id === d.id) ? '#6A50FF' : '#322C2E')
            .attr('opacity', l => (l.source.id === d.id || l.target.id === d.id) ? 1 : 0.1);
      }
    }

    // Update popup position based on node position and zoom transform
    function updatePopupPosition(d, svg) {
      const popup = document.getElementById('popup');
      const transform = d3.zoomTransform(svg.node());
      const x = d.x * transform.k + transform.x;
      const y = d.y * transform.k + transform.y;
      popup.style.left = (x + 15) + 'px';
      popup.style.top = (y + 15) + 'px';
    }

    // ============================================
    // Data Loading and Initialization
    // ============================================
    // Load graph data and initialize the visualization
    fetch('data.json')
      .then(r => r.json())
      .then((data) => {
        const filtersEl = document.getElementById('filters');
        const onChange = (sel) => {
          window.currentSelected = sel;
          renderGraph(data, sel);
        };
        window.currentOnChange = onChange;
        let currentSelected = buildFilters(filtersEl, data.filter_options || {}, onChange);
        window.currentSelected = currentSelected;
        renderGraph(data, currentSelected);
        window.addEventListener('resize', () => renderGraph(data, window.currentSelected || currentSelected));
      });
  </script>
</body>
</html>
